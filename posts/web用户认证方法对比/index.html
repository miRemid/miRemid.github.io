<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="Web用户认证方法对比"><meta itemprop=description content="
本文翻译自testdriven.io

在这篇文章，我们将从一名Python开发者的视角来观察目前最常见的几种处理Web认证的方式

尽管本片文章所有的代码是面向Python开发者的，但是实际上对所有的Web开发者，每种认证方法实际上都是差不多的

认证vs授权(Authentication vs Authorization)
认证是一种处理用户或设备尝试通过凭证来访问受限系统的过程。而授权则是验证用户或设备是否有权限来访问系统提供的确切服务
简单来讲就是

认证：你是谁？
授权：你可以做什么？

认证比授权出现的更早，用户必须在获得访问资源权限之前经过合法验证。最常见的用户认证方法就是username和password。一旦认证完成，不同身份例如admin、moderator等等，都将被附加在用户身上用于提供访问系统的身份信息。
有了上述的解释，让我们来看一看验证用户的不同方法吧"><meta itemprop=datePublished content="2021-01-08T21:33:13+00:00"><meta itemprop=dateModified content="2021-01-08T21:33:13+00:00"><meta itemprop=wordCount content="809"><meta itemprop=keywords content="web,python,"><meta property="og:title" content="Web用户认证方法对比"><meta property="og:description" content="
本文翻译自testdriven.io

在这篇文章，我们将从一名Python开发者的视角来观察目前最常见的几种处理Web认证的方式

尽管本片文章所有的代码是面向Python开发者的，但是实际上对所有的Web开发者，每种认证方法实际上都是差不多的

认证vs授权(Authentication vs Authorization)
认证是一种处理用户或设备尝试通过凭证来访问受限系统的过程。而授权则是验证用户或设备是否有权限来访问系统提供的确切服务
简单来讲就是

认证：你是谁？
授权：你可以做什么？

认证比授权出现的更早，用户必须在获得访问资源权限之前经过合法验证。最常见的用户认证方法就是username和password。一旦认证完成，不同身份例如admin、moderator等等，都将被附加在用户身上用于提供访问系统的身份信息。
有了上述的解释，让我们来看一看验证用户的不同方法吧"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.zxykm.xyz/posts/web%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E6%96%B9%E6%B3%95%E5%AF%B9%E6%AF%94/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-01-08T21:33:13+00:00"><meta property="article:modified_time" content="2021-01-08T21:33:13+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Web用户认证方法对比"><meta name=twitter:description content="
本文翻译自testdriven.io

在这篇文章，我们将从一名Python开发者的视角来观察目前最常见的几种处理Web认证的方式

尽管本片文章所有的代码是面向Python开发者的，但是实际上对所有的Web开发者，每种认证方法实际上都是差不多的

认证vs授权(Authentication vs Authorization)
认证是一种处理用户或设备尝试通过凭证来访问受限系统的过程。而授权则是验证用户或设备是否有权限来访问系统提供的确切服务
简单来讲就是

认证：你是谁？
授权：你可以做什么？

认证比授权出现的更早，用户必须在获得访问资源权限之前经过合法验证。最常见的用户认证方法就是username和password。一旦认证完成，不同身份例如admin、moderator等等，都将被附加在用户身上用于提供访问系统的身份信息。
有了上述的解释，让我们来看一看验证用户的不同方法吧"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><title>Web用户认证方法对比</title><link rel=stylesheet href=https://blog.zxykm.xyz/css/style.min.c1b3099ce41f35b7639d431516f2353f97b3dfb24416e2757de18bdbf9b85401.css integrity="sha256-wbMJnOQfNbdjnUMVFvI1P5ez37JEFuJ1feGL2/m4VAE=" crossorigin=anonymous></head><body id=page><header id=site-header class="animated slideInUp"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://blog.zxykm.xyz>狸猫窝</a></div><nav class="site-nav hide-in-mobile"><a href=https://blog.zxykm.xyz/posts/>Posts</a>
<a href=https://blog.zxykm.xyz/tags/>Tags</a>
<a href=https://blog.zxykm.xyz/about-me/>About</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href=https://github.com/miRemid target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://blog.zxykm.xyz/posts/>Posts</a></li><li><a href=https://blog.zxykm.xyz/tags/>Tags</a></li><li><a href=https://blog.zxykm.xyz/about-me/>About</a></li></ul></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-meta><span>Jan 8, 2021</span></div><h1>Web用户认证方法对比</h1></header><div class=content><blockquote><p>本文翻译自<a href=https://testdriven.io/blog/web-authentication-methods/#authentication-vs-authorization>testdriven.io</a></p></blockquote><p>在这篇文章，我们将从一名Python开发者的视角来观察目前最常见的几种处理Web认证的方式</p><blockquote><p>尽管本片文章所有的代码是面向Python开发者的，但是实际上对所有的Web开发者，每种认证方法实际上都是差不多的</p></blockquote><h1 id=认证vs授权authentication-vs-authorization>认证vs授权(Authentication vs Authorization)<a href=#认证vs授权authentication-vs-authorization class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>认证是一种处理用户或设备尝试通过凭证来访问受限系统的过程。而授权则是验证用户或设备是否有权限来访问系统提供的确切服务</p><p>简单来讲就是</p><ul><li>认证：你是谁？</li><li>授权：你可以做什么？</li></ul><p>认证比授权出现的更早，用户必须在获得访问资源权限之前经过合法验证。最常见的用户认证方法就是<code>username</code>和<code>password</code>。一旦认证完成，不同身份例如<code>admin</code>、<code>moderator</code>等等，都将被附加在用户身上用于提供访问系统的身份信息。</p><p>有了上述的解释，让我们来看一看验证用户的不同方法吧</p><h1 id=http基本认证http-basic-authentication>HTTP基本认证(HTTP Basic Authentication)<a href=#http基本认证http-basic-authentication class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>基本认证是一种建立在HTTP协议上的最基础的验证方式。在基本认证中，每一个请求<code>Header</code>都要携带登录凭证信息</p><pre><code>&quot;Authorization: Basic dXNlcm5hbWU6cGFzc3dvcmQ=&quot; your-website.com
</code></pre><p>用户名和密码都没有被加密，并且用户名和密码通过<code>:</code>组合在一起<code>username:password</code>。这个字符串通常需要通过<code>Base64</code>编码生成</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=o>&gt;&gt;&gt;</span> <span class=kn>import</span> <span class=nn>base64</span>
<span class=o>&gt;&gt;&gt;</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>auth</span> <span class=o>=</span> <span class=s2>&#34;username:password&#34;</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>auth_bytes</span> <span class=o>=</span> <span class=n>auth</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;ascii&#39;</span><span class=p>)</span> <span class=c1># convert to bytes</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>auth_bytes</span>
<span class=sa>b</span><span class=s1>&#39;username:password&#39;</span>
<span class=o>&gt;&gt;&gt;</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>encoded</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>auth_bytes</span><span class=p>)</span> <span class=c1># base64 encode</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>encoded</span>
<span class=sa>b</span><span class=s1>&#39;dXNlcm5hbWU6cGFzc3dvcmQ=&#39;</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=n>encoded</span><span class=p>)</span> <span class=c1># base64 decode</span>
<span class=sa>b</span><span class=s1>&#39;username:password&#39;</span><span class=o>.</span>
</code></pre></div><p>这种方法是无状态的因此客户端必须在每个请求中携带次凭证，这种方法非常适合单一的简单的不需要持久<code>sessions</code>的API的调用</p><h2 id=流程>流程<a href=#流程 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ol><li>未认证的客户端请求一个受限的资源</li><li>HTTP返回401状态码并携带<code>Basic</code>值的名为<code>WWW-Authenticate</code>的header</li><li><code>WWW-Authenticate: Basic</code>让浏览器提示用户密码输入</li><li>在输入凭证之后，在每一个请求的Header中都将携带该凭证<code>Authorization: Basic dcdvcmQ=</code>
<img src=https://testdriven.io/static/images/blog/web-authentication-methods/basic_auth.png alt=基本认证></li></ol><h2 id=优点>优点<a href=#优点 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ol><li>步骤少，认证过程快</li><li>实现简单</li><li>主流浏览器都支持</li></ol><h2 id=缺点>缺点<a href=#缺点 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ol><li>Base64并不是真正意义上的加密算法，只是另一种呈现数据的方式。Base64字符串很容易在发送文本的时候被解码。弱安全性会遭来各种各样的攻击，因此<code>HTTPS/SSL</code>非常有必要</li><li>在每个请求都必须携带凭证</li><li>用户只能通过写入一个错误的凭证用于登出</li></ol><h2 id=第三方依赖python下同>第三方依赖(Python下同)<a href=#第三方依赖python下同 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ul><li><a href=https://flask-httpauth.readthedocs.io/>Flask-HTTPAuth</a></li><li><a href=https://github.com/hirokiky/django-basicauth/>django-basicauth</a></li><li><a href=https://fastapi.tiangolo.com/advanced/security/http-basic-auth/>FastAPI:HTTP Basic Auth</a></li></ul><h2 id=代码>代码<a href=#代码 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>用<code>Flask-HTTP</code>可以使用Flask非常轻松的实现基本认证</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Flask</span>
<span class=kn>from</span> <span class=nn>flask_httpauth</span> <span class=kn>import</span> <span class=n>HTTPBasicAuth</span>
<span class=kn>from</span> <span class=nn>werkzeug.security</span> <span class=kn>import</span> <span class=n>generate_password_hash</span><span class=p>,</span> <span class=n>check_password_hash</span>

<span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
<span class=n>auth</span> <span class=o>=</span> <span class=n>HTTPBasicAuth</span><span class=p>()</span>

<span class=n>users</span> <span class=o>=</span> <span class=p>{</span>
    <span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=n>generate_password_hash</span><span class=p>(</span><span class=s2>&#34;password&#34;</span><span class=p>),</span>
<span class=p>}</span>


<span class=nd>@auth.verify_password</span>
<span class=k>def</span> <span class=nf>verify_password</span><span class=p>(</span><span class=n>username</span><span class=p>,</span> <span class=n>password</span><span class=p>):</span>
    <span class=k>if</span> <span class=n>username</span> <span class=ow>in</span> <span class=n>users</span> <span class=ow>and</span> <span class=n>check_password_hash</span><span class=p>(</span><span class=n>users</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;username&#34;</span><span class=p>),</span> <span class=n>password</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>username</span>


<span class=nd>@app.route</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>)</span>
<span class=nd>@auth.login_required</span>
<span class=k>def</span> <span class=nf>index</span><span class=p>():</span>
    <span class=k>return</span> <span class=n>f</span><span class=s2>&#34;You have successfully logged in, {auth.current_user()}&#34;</span>


<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
    <span class=n>app</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</code></pre></div><h2 id=资料>资料<a href=#资料 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ul><li><a href=https://tools.ietf.org/html/rfc7617>IETF: The &lsquo;Basic&rsquo; HTTP Authentication Scheme</a></li><li><a href=https://blog.miguelgrinberg.com/post/restful-authentication-with-flask>RESTful Authentication with Flask</a></li><li><a href=https://www.django-rest-framework.org/api-guide/authentication/#basicauthentication>DRF Basic Authentication Guide</a></li><li><a href=https://gist.github.com/nilsdebruin/8b36cd98c9949a1a87e3a582f70146f1>FastAPI Basic Authentication Example</a></li></ul><h1 id=http摘要验证http-digest-authentication>HTTP摘要验证(HTTP Digest Authentication)<a href=#http摘要验证http-digest-authentication class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>HTTP摘要验证(或称HTTP摘要权限验证)是一种比HTTP基本认证更安全的方式。这两种方法的最大的区别就是传输的密码是用md5算法的Hash字符串</p><h2 id=流程-1>流程<a href=#流程-1 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ol><li>未验证的客户端请求一个受限资源</li><li>服务端生成一个随机的值用于提示并通过返回一个值为<code>Digest</code>的<code>WWW-Authenticate</code>Header并返回401未验证状态码，整个Header为<code>WWW-Authenticate: Digest nonce="44f0437004157342f50f935906ad46fc"</code></li><li><code>WWW-Authenticate</code>会让浏览器提示输入帐号密码</li><li>在输入凭证之后，密码会进行Hash处理并在每一个请求的Header中添加一条声明信息<code>Authorization: Digest username="username",nonce="16e30069e45a7f47b4e2606aeeb7ab62", response="89549b93e13d438cd0946c6d93321c52"</code></li><li>通过账户名，服务端获取对应的密码进行Hash处理并对声明中的信息进行比较是否相同
![HTTP Digest Authentication]https://testdriven.io/static/images/blog/web-authentication-methods/digest_auth.png)</li></ol><h2 id=优点-1>优点<a href=#优点-1 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ol><li>比基本验证拥有更强的安全性</li><li>实现简单</li><li>主流浏览器基本都支持</li></ol><h2 id=缺点-1>缺点<a href=#缺点-1 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ol><li>必须在每个请求都携带凭证</li><li>用户只能重新提交个不正确的凭证来登出</li><li>与基本验证相比，由于密码不能加密保存因此在服务端安全性较差</li><li>很容易收到中间人袭击</li></ol><h2 id=第三方依赖>第三方依赖<a href=#第三方依赖 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ul><li><a href=https://flask-httpauth.readthedocs.io/>Flask-HTTPAuth</a></li></ul><h2 id=代码-1>代码<a href=#代码-1 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>用<code>Flask-HTTP</code>可以使用Flask非常轻松的实现</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Flask</span>
<span class=kn>from</span> <span class=nn>flask_httpauth</span> <span class=kn>import</span> <span class=n>HTTPDigestAuth</span>

<span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
<span class=n>app</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s2>&#34;SECRET_KEY&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;change me&#34;</span>
<span class=n>auth</span> <span class=o>=</span> <span class=n>HTTPDigestAuth</span><span class=p>()</span>

<span class=n>users</span> <span class=o>=</span> <span class=p>{</span>
    <span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;password&#34;</span>
<span class=p>}</span>


<span class=nd>@auth.get_password</span>
<span class=k>def</span> <span class=nf>get_user</span><span class=p>(</span><span class=n>username</span><span class=p>):</span>
    <span class=k>if</span> <span class=n>username</span> <span class=ow>in</span> <span class=n>users</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>users</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>username</span><span class=p>)</span>


<span class=nd>@app.route</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>)</span>
<span class=nd>@auth.login_required</span>
<span class=k>def</span> <span class=nf>index</span><span class=p>():</span>
    <span class=k>return</span> <span class=n>f</span><span class=s2>&#34;You have successfully logged in, {auth.current_user()}&#34;</span>


<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
    <span class=n>app</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</code></pre></div><h2 id=资料-1>资料<a href=#资料-1 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ul><li><a href=https://tools.ietf.org/html/rfc7616>IETF: HTTP Digest Access Authentication</a></li><li><a href=https://2.python-requests.org/en/latest/user/authentication/#digest-authentication>Digest Authentication from the Requests library</a></li></ul><h1 id=会话认证session-based-auth>会话认证(Session-based Auth)<a href=#会话认证session-based-auth class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>通过会话，用户状态可以存储在服务端上。这并不需要用户每次请求都携带账户密码信息。而是在他们登录过后，在服务端会验证登录凭证，如果是合法的，就会创建一个会话并存储在会话池中，然后返回该会话的唯一标识ID(Session ID)给浏览器，浏览器会将该ID当作cookie保存在浏览器中并在每次请求时携带该cookie</p><h2 id=流程-2>流程<a href=#流程-2 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p><img src=https://testdriven.io/static/images/blog/web-authentication-methods/session_auth.png alt="Session-based Auth"></p><h2 id=优点-2>优点<a href=#优点-2 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ol><li>由于不需要携带登录凭证，在后续的判断登录会十分迅速</li><li>提高了用户体验</li><li>容易实现，很多框架(例如Django)提供了这种验证方法并开箱即用</li></ol><h2 id=缺点-2>缺点<a href=#缺点-2 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ol><li>Session是有状态的。服务端会跟踪每一个会话。用于存储会话信息的会话池需要给众多服务提供验证服务。因此，这对RESTful服务来说并不友好，因为REST是一种无状态协议</li><li>每一个请求都会携带cookie信息，就算是不需要验证的请求也如此</li><li>对CSRF攻击的防护不足([什么是CSRF，如何在Flask中抵御CSRF攻击]https://testdriven.io/blog/csrf-flask/))</li></ol><h2 id=第三方依赖-1>第三方依赖<a href=#第三方依赖-1 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ol><li><a href=https://flask-login.readthedocs.io/>Flask-Login</a></li><li><a href=https://flask-httpauth.readthedocs.io/>Flask-HTTPAuth</a></li><li><a href=https://docs.djangoproject.com/en/3.1/topics/auth/>User authentication in Django</a></li><li><a href=https://github.com/MushroomMaula/fastapi_login>FastAPI-Login</a></li><li><a href=https://github.com/frankie567/fastapi-users>FastAPI-Users</a></li></ol><h2 id=代码-2>代码<a href=#代码-2 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p><code>Flask-login</code>对会话验证非常合适，该包负责登录和注销，并可以在一段时间内记住用户信息</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Flask</span><span class=p>,</span> <span class=n>request</span>
<span class=kn>from</span> <span class=nn>flask_login</span> <span class=kn>import</span> <span class=p>(</span>
    <span class=n>LoginManager</span><span class=p>,</span>
    <span class=n>UserMixin</span><span class=p>,</span>
    <span class=n>current_user</span><span class=p>,</span>
    <span class=n>login_required</span><span class=p>,</span>
    <span class=n>login_user</span><span class=p>,</span>
<span class=p>)</span>
<span class=kn>from</span> <span class=nn>werkzeug.security</span> <span class=kn>import</span> <span class=n>generate_password_hash</span><span class=p>,</span> <span class=n>check_password_hash</span>


<span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
<span class=n>app</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>update</span><span class=p>(</span>
    <span class=n>SECRET_KEY</span><span class=o>=</span><span class=s2>&#34;change_this_key&#34;</span><span class=p>,</span>
<span class=p>)</span>

<span class=n>login_manager</span> <span class=o>=</span> <span class=n>LoginManager</span><span class=p>()</span>
<span class=n>login_manager</span><span class=o>.</span><span class=n>init_app</span><span class=p>(</span><span class=n>app</span><span class=p>)</span>


<span class=n>users</span> <span class=o>=</span> <span class=p>{</span>
    <span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=n>generate_password_hash</span><span class=p>(</span><span class=s2>&#34;password&#34;</span><span class=p>),</span>
<span class=p>}</span>


<span class=k>class</span> <span class=nc>User</span><span class=p>(</span><span class=n>UserMixin</span><span class=p>):</span>
    <span class=o>...</span>


<span class=nd>@login_manager.user_loader</span>
<span class=k>def</span> <span class=nf>user_loader</span><span class=p>(</span><span class=n>username</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
    <span class=k>if</span> <span class=n>username</span> <span class=ow>in</span> <span class=n>users</span><span class=p>:</span>
        <span class=n>user_model</span> <span class=o>=</span> <span class=n>User</span><span class=p>()</span>
        <span class=n>user_model</span><span class=o>.</span><span class=n>id</span> <span class=o>=</span> <span class=n>username</span>
        <span class=k>return</span> <span class=n>user_model</span>
    <span class=k>return</span> <span class=bp>None</span>


<span class=nd>@app.route</span><span class=p>(</span><span class=s2>&#34;/login&#34;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;POST&#34;</span><span class=p>])</span>
<span class=k>def</span> <span class=nf>login_page</span><span class=p>():</span>
    <span class=n>data</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>get_json</span><span class=p>()</span>
    <span class=n>username</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;username&#34;</span><span class=p>)</span>
    <span class=n>password</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;password&#34;</span><span class=p>)</span>

    <span class=k>if</span> <span class=n>username</span> <span class=ow>in</span> <span class=n>users</span><span class=p>:</span>
        <span class=k>if</span> <span class=n>check_password_hash</span><span class=p>(</span><span class=n>users</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>username</span><span class=p>),</span> <span class=n>password</span><span class=p>):</span>
            <span class=n>user_model</span> <span class=o>=</span> <span class=n>User</span><span class=p>()</span>
            <span class=n>user_model</span><span class=o>.</span><span class=n>id</span> <span class=o>=</span> <span class=n>username</span>
            <span class=n>login_user</span><span class=p>(</span><span class=n>user_model</span><span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>return</span> <span class=s2>&#34;Wrong credentials&#34;</span>
    <span class=k>return</span> <span class=s2>&#34;logged in&#34;</span>


<span class=nd>@app.route</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>)</span>
<span class=nd>@login_required</span>
<span class=k>def</span> <span class=nf>protected</span><span class=p>():</span>
    <span class=k>return</span> <span class=n>f</span><span class=s2>&#34;Current user: {current_user.id}&#34;</span>


<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
    <span class=n>app</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</code></pre></div><h2 id=资料-2>资料<a href=#资料-2 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ul><li><a href=https://tools.ietf.org/id/draft-broyer-http-cookie-auth-00.html>IETF: Cookie-based HTTP Authentication</a></li><li><a href=https://www.digitalocean.com/community/tutorials/how-to-add-authentication-to-your-app-with-flask-login>How To Add Authentication to Your App with Flask-Login</a></li><li><a href=https://testdriven.io/blog/flask-spa-auth/>Session-based Auth with Flask for Single Page Apps</a></li><li><a href=https://testdriven.io/blog/csrf-flask/>CSRF Protection in Flask</a></li><li><a href=https://learndjango.com/tutorials/django-login-and-logout-tutorial>Django Login and Logout Tutorial</a></li><li><a href=https://testdriven.io/blog/django-spa-auth/>Django Session-based Auth for Single Page Apps</a></li><li><a href=https://frankie567.github.io/fastapi-users/configuration/authentication/cookie/>FastAPI-Users: Cookie Auth</a></li></ul><h1 id=令牌验证token-based-authentication>令牌验证(Token-Based Authentication)<a href=#令牌验证token-based-authentication class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>这种方法是将cookies用令牌认证替代。用户提供登录凭证服务端返回一种标识令牌，这个令牌将会在后续的请求中携带</p><p>最常见并广泛应用的令牌是<code>JSON Web Token</code>([JWT]https://jwt.io/))。JWT由三部分组成</p><ul><li>Header(携带令牌的类型和使用的Hash算法类型)</li><li>Payload(携带对该令牌信息的声明结构体)</li><li>Signature(用于验证信息是否在传输过程中发生错误)</li></ul><p>以上三部分都将使用base64编码，并且每部分都会进行Hash处理，不同类型中间用<code>.</code>分割。由于这些信息都被编码过，任何人都能通过解码来查看携带的信息。但是只有验证的用户才能生成合法的令牌。令牌将会通过签名来验证合法性。</p><blockquote><p>JWT是一种紧凑的、URL安全的方法，用于表示在两方互相传输的声明。在JWT中，声明信息被编码成JSON信息，用于JWS或者JWE，从而使声明可以进行数字签名或完整性保护[IETE]https://tools.ietf.org/html/rfc7519)(翻译的不是很好)</p></blockquote><p>服务端并不需要保存令牌，令牌只能使用签名来验证。最近，由于RESTful API和单页应用程序的兴起，令牌验证这种方法的采用有所增加</p><h2 id=流程-3>流程<a href=#流程-3 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p><img src=https://testdriven.io/static/images/blog/web-authentication-methods/token_auth.png alt="Token-Based Auth"></p><h2 id=优点-3>优点<a href=#优点-3 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ol><li>无状态。服务端不需要存储令牌，只需要令牌中的签名用于验证。这方每个请求不需要调用数据库从而更加快速</li><li>对多个服务需要验证的微服务架构来说非常合适。我们只需要配置如何处理令牌和令牌密钥。</li></ol><h2 id=缺点-3>缺点<a href=#缺点-3 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ol><li>客户端需要考虑如何存储令牌，这可能导致XSS或者CSRF攻击</li><li>令牌不可删除，只能过期。这意味着如果令牌泄漏，攻击者可以使用这个令牌直至过期。因此非常有必要对令牌设置一个较短的过期时间例如15分钟</li><li>需要在令牌快过期时进行令牌的自动刷新</li><li>删除令牌的唯一方式是创建一个数据库或者黑名单。这会对微服务架构来说增加额外的负担和潜在的问题。</li></ol><h2 id=第三方依赖-2>第三方依赖<a href=#第三方依赖-2 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ul><li><a href=https://github.com/vimalloc/flask-jwt-extended>Flask-JWT-Extended</a></li><li><a href=https://flask-httpauth.readthedocs.io/>Flask-HTTPAuth</a></li><li><a href=https://github.com/SimpleJWT/django-rest-framework-simplejwt>Simple JWT for Django REST Framework</a></li><li><a href=https://github.com/IndominusByte/fastapi-jwt-auth>FastAPI JWT Auth</a></li></ul><h2 id=代码-3>代码<a href=#代码-3 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p><code>Flask-JWT-Extended</code>可以提供处理JWT的许多方法</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Flask</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>jsonify</span>
<span class=kn>from</span> <span class=nn>flask_jwt_extended</span> <span class=kn>import</span> <span class=p>(</span>
    <span class=n>JWTManager</span><span class=p>,</span>
    <span class=n>jwt_required</span><span class=p>,</span>
    <span class=n>create_access_token</span><span class=p>,</span>
    <span class=n>get_jwt_identity</span><span class=p>,</span>
<span class=p>)</span>
<span class=kn>from</span> <span class=nn>werkzeug.security</span> <span class=kn>import</span> <span class=n>check_password_hash</span><span class=p>,</span> <span class=n>generate_password_hash</span>

<span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
<span class=n>app</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>update</span><span class=p>(</span>
    <span class=n>JWT_SECRET_KEY</span><span class=o>=</span><span class=s2>&#34;please_change_this&#34;</span><span class=p>,</span>
<span class=p>)</span>

<span class=n>jwt</span> <span class=o>=</span> <span class=n>JWTManager</span><span class=p>(</span><span class=n>app</span><span class=p>)</span>

<span class=n>users</span> <span class=o>=</span> <span class=p>{</span>
    <span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=n>generate_password_hash</span><span class=p>(</span><span class=s2>&#34;password&#34;</span><span class=p>),</span>
<span class=p>}</span>


<span class=nd>@app.route</span><span class=p>(</span><span class=s2>&#34;/login&#34;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;POST&#34;</span><span class=p>])</span>
<span class=k>def</span> <span class=nf>login_page</span><span class=p>():</span>
    <span class=n>username</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>json</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;username&#34;</span><span class=p>)</span>
    <span class=n>password</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>json</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;password&#34;</span><span class=p>)</span>

    <span class=k>if</span> <span class=n>username</span> <span class=ow>in</span> <span class=n>users</span><span class=p>:</span>
        <span class=k>if</span> <span class=n>check_password_hash</span><span class=p>(</span><span class=n>users</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>username</span><span class=p>),</span> <span class=n>password</span><span class=p>):</span>
            <span class=n>access_token</span> <span class=o>=</span> <span class=n>create_access_token</span><span class=p>(</span><span class=n>identity</span><span class=o>=</span><span class=n>username</span><span class=p>)</span>
            <span class=k>return</span> <span class=n>jsonify</span><span class=p>(</span><span class=n>access_token</span><span class=o>=</span><span class=n>access_token</span><span class=p>),</span> <span class=mi>200</span>

    <span class=k>return</span> <span class=s2>&#34;Wrong credentials&#34;</span><span class=p>,</span> <span class=mi>400</span>


<span class=nd>@app.route</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>)</span>
<span class=nd>@jwt_required</span>
<span class=k>def</span> <span class=nf>protected</span><span class=p>():</span>
    <span class=k>return</span> <span class=n>jsonify</span><span class=p>(</span><span class=n>logged_in_as</span><span class=o>=</span><span class=n>get_jwt_identity</span><span class=p>()),</span> <span class=mi>200</span>


<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
    <span class=n>app</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</code></pre></div><h2 id=资料-3>资料<a href=#资料-3 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ul><li><a href=https://jwt.io/introduction>Introduction to JSON Web Tokens</a></li><li><a href=https://tools.ietf.org/html/rfc7519>IETF: JSON Web Token (JWT)</a></li><li><a href=https://simpleisbetterthancomplex.com/tutorial/2018/12/19/how-to-use-jwt-authentication-with-django-rest-framework.html>How to Use JWT Authentication with Django REST Framework</a></li><li><a href=https://testdriven.io/blog/fastapi-jwt-auth/>Securing FastAPI with JWT Token-based Authentication</a></li><li><a href=https://blog.asayer.io/jwt-authentication-best-practices>JWT Authentication Best Practices</a></li></ul><h1 id=一次性密码one-time-passwords>一次性密码(One Time Passwords)<a href=#一次性密码one-time-passwords class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>一次性密码通常用于确认认证消息。OTPs会随机生成代码用于验证用户是否是声明中的。也经常用于APP中的二次验证</p><p>为了使用OTPs，必须要有一个可靠可信赖的系统。这个系统将会用于验证email或电话</p><p>现代OTPs是无状态的，并且有很多方法来验证。尽管有很多类型的OTPs，但是基于时间的OTPs(TOTPs)是目前毫无争议使用最多的方法。验证代码在生成过后会在一段时间后过期。</p><p>由于你添加了一层安全检查，OTPS可以用于处理一些安全性高度需要的APP例如银行或其他金融服务</p><h2 id=流程-4>流程<a href=#流程-4 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>传统的OTPS验证流程如下</p><ul><li>客户端发送用户密码</li><li>在认证过后，服务端生成随机的代码，保存在服务端并返回给可信赖的系统</li><li>客户通过可信赖系统获取生成的代码，在APP中输入返回给客户端</li><li>服务端验证代码是否和保存的一致，如果符合则放行</li></ul><p>基于时间的TOTPS流程如下</p><ul><li>客户端发送用户密码</li><li>在认证后，服务端通过随机种子生成随机代码，保存在服务端并返回给可信赖的系统</li><li>客户通过可信赖系统获取生成的代码，在APP中输入返回给客户端</li><li>服务端验证代码是否和存储的代码一致并且没有过期，如果符合则放行</li></ul><p>例如<a href=https://en.wikipedia.org/wiki/Google_Authenticator>Google Authenticator</a>, <a href=https://www.microsoft.com/en-us/account/authenticator>Microsoft Authenticator</a>, <a href=https://en.wikipedia.org/wiki/FreeOTP>FreeOTP</a>的OTP代理商工作流程</p><ul><li>在代理生认证2FA后，服务器生成一个随机种子，并以唯一的二维码形式发送给用户</li><li>用户通过2FA应用扫描二维码用于验证信赖设备</li><li>当OTP需要时，用户会检查设备中的代码，并且在Web中输入</li><li>服务端验证输入的代码，如果符合则放行</li></ul><h2 id=优点-4>优点<a href=#优点-4 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ul><li>添加了一层防护层</li><li>密码泄漏的危险性降低，或者说服务只会通过OTP验证</li></ul><h2 id=缺点-4>缺点<a href=#缺点-4 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ul><li>你需要存储OTPs生成的种子</li><li>如果你丢失了回复代码，OTP代理商例如Google Authenticator非常难设置</li><li>当可信赖设备不可使用时会产生诸多问题(没电，网络错误等等)。因此，添加备用设备非常有必要</li></ul><h2 id=第三方依赖-3>第三方依赖<a href=#第三方依赖-3 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ul><li><a href=https://pyauth.github.io/pyotp/>PyOTP - The Python One-Time Password Library</a></li><li><a href=https://github.com/django-otp/django-otp>django-otp</a></li></ul><h2 id=代码-4>代码<a href=#代码-4 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p><code>PyOTP</code>提供了基于时间和基于计数器的OTPs</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>time</span> <span class=kn>import</span> <span class=n>sleep</span>

<span class=kn>import</span> <span class=nn>pyotp</span>

<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
    <span class=n>otp</span> <span class=o>=</span> <span class=n>pyotp</span><span class=o>.</span><span class=n>TOTP</span><span class=p>(</span><span class=n>pyotp</span><span class=o>.</span><span class=n>random_base32</span><span class=p>())</span>
    <span class=n>code</span> <span class=o>=</span> <span class=n>otp</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
    <span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=s2>&#34;OTP generated: {code}&#34;</span><span class=p>)</span>
    <span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=s2>&#34;Verify OTP: {otp.verify(code)}&#34;</span><span class=p>)</span>
    <span class=n>sleep</span><span class=p>(</span><span class=mi>30</span><span class=p>)</span>
    <span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=s2>&#34;Verify after 30s: {otp.verify(code)}&#34;</span><span class=p>)</span>
</code></pre></div><pre><code>OTP generated: 474771
Verify OTP: True
Verify after 30s: False
</code></pre><h2 id=资料-4>资料<a href=#资料-4 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ul><li><a href=https://tools.ietf.org/html/rfc6238>IETF: TOTP: Time-Based One-Time Password Algorithm</a></li><li><a href=https://tools.ietf.org/html/rfc2289>IETF: A One-Time Password System</a></li><li><a href=https://hackernoon.com/implementing-2fa-how-time-based-one-time-password-actually-works-with-python-examples-cm1m3ywt>Implementing 2FA: How Time-Based One-Time Password Actually Works (With Python Examples)</a></li></ul><h1 id=oauth和openid>OAuth和OpenID<a href=#oauth和openid class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>OAuth/OAuth2和OpenID时目前比较火的认证方法。他们都要求实现社交登录(一种单点登录形式)，使用来自社交网络服务(例如Facebook，Twitter或谷歌)现有的信息介入第三方网站，而不是创建一个新的登录账户</p><p>这种类型的认证授权可以在你需要高度安全认证时使用。一些提供商有组够多的资源来处理认证。利用这些久经考验的认证系统可以让你的应用更为的安全。</p><p>这种方法通常与会话认证搭配使用</p><h2 id=流程-5>流程<a href=#流程-5 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>你浏览一些需要登录的网站，你进入登录界面并发现一个<code>使用谷歌登录</code>的按钮。你点击按钮后会引导你进入谷歌登录界面。一旦登录认证完成，你会被重定向至刚刚浏览的需要登录的网站。这是一种使用OpenID认证的例子。它会让你用一个现成的账户登录而并不需要再创建一个新帐号</p><p>最著名的OpenID提供商有谷歌，Facebook，Github</p><p>在登录过后，你进入网站的下载服务，在下载大文件时直接接入到谷歌云中。网站是如何访问你的谷歌云的呢？这就是OAuth发挥作用的时候。你可以在授予访问其他网站上资源的权限，比如此时的谷歌云访问权限。</p><h2 id=优点-5>优点<a href=#优点-5 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ul><li>提高了安全性</li><li>更容易且快速的登录流程，不需要额外创建一个账户</li><li>由于认证时无密码的，一旦出现安全漏洞，不会对第三方造成损害</li></ul><h2 id=缺点-5>缺点<a href=#缺点-5 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ul><li>你需要依赖不在你掌控的第三方APP。如果OpenID服务宕机，用户就不能再进行登录</li><li>人通常会护士OAuth应用的授权信息</li><li>没有配置OpenID提供上账户的用户将无法访问你的应用。最好的方法是本站注册和OAuth认证同时做。</li></ul><h2 id=第三方依赖-4>第三方依赖<a href=#第三方依赖-4 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>社交登录</p><ul><li><a href=https://authomatic.github.io/authomatic/>Authomatic</a></li><li><a href=https://python-social-auth.readthedocs.io/>Python Social Auth</a></li><li><a href=https://flask-dance.readthedocs.io/>Flask-Dance</a></li><li><a href=https://django-allauth.readthedocs.io/>django-allauth</a></li></ul><p>创建自己的OAuth或OpenID服务</p><ul><li><a href=https://authlib.org/>Authlib</a></li><li><a href=https://oauthlib.readthedocs.io/>OAuthLib</a></li><li><a href=https://flask-oauthlib.readthedocs.io/>Flask-OAuthlib</a></li><li><a href=https://django-oauth-toolkit.readthedocs.io/>Django OAuth Toolkit</a></li><li><a href=https://django-oidc-provider.readthedocs.io/>Django OIDC Provider</a></li><li><a href=https://fastapi.tiangolo.com/tutorial/security/simple-oauth2/>FastAPI: Simple OAuth2 with Password and Bearer</a></li><li><a href=https://fastapi.tiangolo.com/tutorial/security/oauth2-jwt/#advanced-usage-with-scopes>FastAPI: OAuth2 with Password (and hashing), Bearer with JWT tokens</a></li></ul><h2 id=代码-5>代码<a href=#代码-5 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>你可以通过<code>Flask-Dance</code>接入Github服务</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Flask</span><span class=p>,</span> <span class=n>url_for</span><span class=p>,</span> <span class=n>redirect</span>
<span class=kn>from</span> <span class=nn>flask_dance.contrib.github</span> <span class=kn>import</span> <span class=n>make_github_blueprint</span><span class=p>,</span> <span class=n>github</span>

<span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
<span class=n>app</span><span class=o>.</span><span class=n>secret_key</span> <span class=o>=</span> <span class=s2>&#34;change me&#34;</span>
<span class=n>app</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s2>&#34;GITHUB_OAUTH_CLIENT_ID&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;1aaf1bf583d5e425dc8b&#34;</span>
<span class=n>app</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s2>&#34;GITHUB_OAUTH_CLIENT_SECRET&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;dee0c5bc7e0acfb71791b21ca459c008be992d7c&#34;</span>

<span class=n>github_blueprint</span> <span class=o>=</span> <span class=n>make_github_blueprint</span><span class=p>()</span>
<span class=n>app</span><span class=o>.</span><span class=n>register_blueprint</span><span class=p>(</span><span class=n>github_blueprint</span><span class=p>,</span> <span class=n>url_prefix</span><span class=o>=</span><span class=s2>&#34;/login&#34;</span><span class=p>)</span>


<span class=nd>@app.route</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>index</span><span class=p>():</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=n>github</span><span class=o>.</span><span class=n>authorized</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s2>&#34;github.login&#34;</span><span class=p>))</span>
    <span class=n>resp</span> <span class=o>=</span> <span class=n>github</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;/user&#34;</span><span class=p>)</span>
    <span class=k>assert</span> <span class=n>resp</span><span class=o>.</span><span class=n>ok</span>
    <span class=k>return</span> <span class=n>f</span><span class=s2>&#34;You have successfully logged in, {resp.json()[&#39;login&#39;]}&#34;</span>


<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
    <span class=n>app</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</code></pre></div><h2 id=资料-5>资料<a href=#资料-5 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ul><li><a href=https://developer.okta.com/blog/2019/10/21/illustrated-guide-to-oauth-and-oidc>An Illustrated Guide to OAuth and OpenID Connect</a></li><li><a href=https://mherman.org/presentations/node-oauth-openid/#1>Introduction to OAuth 2.0 and OpenID Connect</a></li><li><a href=https://realpython.com/flask-google-login/>Create a Flask Application With Google Login</a></li><li><a href=https://learndjango.com/tutorials/django-allauth-tutorial>Django-allauth Tutorial</a></li><li><a href=https://medium.com/data-rebels/fastapi-google-as-an-external-authentication-provider-3a527672cf33>FastAPI — Google as an external authentication provider</a></li></ul><h1 id=结论>结论<a href=#结论 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>在这篇文章，我们认识了一些不同的Web认证方法，每一种都有各自的优点和缺点</p><p>在何时使用呢？这就需要具体问题具体分析，通常有几条规则</p><ul><li>对利用服务器模板的Web应用程序，通过用户密码进行会话认证是最合适的。也可以增加OAuth和OpenID作为另一种方式</li><li>对RESTfulAPIs来说，无状态的令牌验证方法是最合适的</li><li>如果你想处理高度敏感的数据，你可能需要在认证过程中添加OTPs</li></ul><p>最后你要知道，上述的例子只是接触到了认证的表皮。在生产环境中需要更深层的配置。</p></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://blog.zxykm.xyz/tags/web>web</a></span><span class=tag><a href=https://blog.zxykm.xyz/tags/python>python</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>809 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2021-01-08 21:33 +0000</p></footer></article><div class="post-nav thin"></div><div id=comments class=thin></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2021 <a href=https://blog.zxykm.xyz>miRemid</a> &#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://blog.zxykm.xyz/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://blog.zxykm.xyz/js/bundle.min.7d8545daa55d62427355498dd8da13f98ff79a7938ce7d2a5e2ae1ec0de3beb8.js integrity="sha256-fYVF2qVdYkJzVUmN2NoT+Y/3mnk4zn0qXirh7A3jvrg=" crossorigin=anonymous></script></body></html>