<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="Innodb事物隔离级别及其锁 美团技术学习"><meta itemprop=description content="
本文是阅读美团技术团队的记录形文章，更详细内容请访问美团技术团队官方网站
"><meta itemprop=datePublished content="2021-06-13T12:40:53+08:00"><meta itemprop=dateModified content="2021-06-13T12:40:53+08:00"><meta itemprop=wordCount content="88"><meta itemprop=keywords content="MySQL,"><meta property="og:title" content="Innodb事物隔离级别及其锁 美团技术学习"><meta property="og:description" content="
本文是阅读美团技术团队的记录形文章，更详细内容请访问美团技术团队官方网站
"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.zxykm.xyz/posts/innodb%E4%BA%8B%E7%89%A9%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E5%8F%8A%E5%85%B6%E9%94%81-%E7%BE%8E%E5%9B%A2%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-13T12:40:53+08:00"><meta property="article:modified_time" content="2021-06-13T12:40:53+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Innodb事物隔离级别及其锁 美团技术学习"><meta name=twitter:description content="
本文是阅读美团技术团队的记录形文章，更详细内容请访问美团技术团队官方网站
"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><title>Innodb事物隔离级别及其锁 美团技术学习</title><link rel=stylesheet href=https://blog.zxykm.xyz/css/style.min.179f5bcfd696f9b21c87e629fd979ce57c09ac5ab20b22524bee5e9d356694d9.css integrity="sha256-F59bz9aW+bIch+Yp/Zec5XwJrFqyCyJSS+5enTVmlNk=" crossorigin=anonymous></head><body id=page><header id=site-header class="animated slideInUp"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://blog.zxykm.xyz>狸猫窝</a></div><nav class="site-nav hide-in-mobile"><a href=https://blog.zxykm.xyz/posts/>Posts</a>
<a href=https://blog.zxykm.xyz/tags/>Tags</a>
<a href=https://blog.zxykm.xyz/about-me/>About</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href=https://github.com/miRemid target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://blog.zxykm.xyz/posts/>Posts</a></li><li><a href=https://blog.zxykm.xyz/tags/>Tags</a></li><li><a href=https://blog.zxykm.xyz/about-me/>About</a></li></ul></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-meta><span>Jun 13, 2021</span></div><h1>Innodb事物隔离级别及其锁 美团技术学习</h1></header><div class=content><blockquote><p>本文是阅读<a href=https://tech.meituan.com/2014/08/20/innodb-lock.html>美团技术团队</a>的记录形文章，更详细内容请访问美团技术团队官方网站</p></blockquote><h1 id=两段锁>两段锁<a href=#两段锁 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>数据库遵循的是两段锁协议，将事务分成两个阶段：加锁和解锁</p><ul><li>加锁阶段：在该阶段对任何数据进行读操作之前都要申请并获得S锁，在进行写操作之前要获取X锁</li><li>解锁阶段：当事务释放一个封锁后，进入解锁阶段，在该阶段只能进行解锁操作不能进行加锁阶段</li></ul><p>两段锁可以保证事务的并发调度是串行化的</p><h1 id=四种隔离级别>四种隔离级别<a href=#四种隔离级别 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><table><thead><tr><th>隔离级别</th><th>脏读</th><th>不可重复读</th><th>幻读</th></tr></thead><tbody><tr><td>未提交读(RU)</td><td>可能</td><td>可能</td><td>可能</td></tr><tr><td>已提交读(RC)</td><td>不可能</td><td>可能</td><td>可能</td></tr><tr><td>可重复读(RR)</td><td>不可能</td><td>不可能</td><td>可能</td></tr><tr><td>可串行化(SE)</td><td>不可能</td><td>不可能</td><td>不可能</td></tr></tbody></table><ul><li>RU：允许脏读，可能读取到其他会话中未提交事务修改的数据</li><li>RC：只能读取到已提交的数据，Oracle默认级别</li><li>RR：在同一个事务内的查询都是事务开始时刻一致性的，InnoDB默认级别，真正消除了不可重复读，但存在幻读</li><li>SE：完全串行执行，读写相互阻塞</li></ul><h1 id=mysql锁的种类>MySQL锁的种类<a href=#mysql锁的种类 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>MySQL中有很多种锁，行锁、表锁等等。表锁是对一整张表加锁，但是会锁住整张表导致并发能力下降，一般在DDL时使用</p><p>行锁则锁住数据行，只锁住有限的数据，并发能力强</p><h1 id=已提交读rc>已提交读(RC)<a href=#已提交读rc class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>在RC中，数据的读取是不加锁的，但是写入、修改和删除是需要加锁的</p><table><thead><tr><th>事务A</th><th>事务B</th></tr></thead><tbody><tr><td>begin;</td><td>begin;</td></tr><tr><td>update class_teacher set class_name=&lsquo;Class1&rsquo; where teacher_id=1;</td><td>update class_teacher set class_name=‘初三三班’ where teacher_id=1;</td></tr><tr><td>commit;</td><td></td></tr></tbody></table><p>为了防止并发过程中修改冲突，事务A中会给teacher_id=1的数据行加锁，并一直不commit，这样事务B就一直拿不到该行锁，wait直到超时</p><p>需要注意的是，teacher_id是有索引的，如果查询的是没有索引的字段呢，那么MySQL会给整张表的所有数据行加行锁(表锁?)。这是因为在SQL运行过程中，MySQL并不知道哪些数据行是需要查询的，如果一个条件无法通过索引快速过滤，就会将所有记录加锁后返回，再由MySQL Server层进行过滤</p><p>但MySQL在这种情况做了一些改进，在Server过滤时会将不满足条件的数据调用unlock_row的方法释放该记录的锁，这就保证了只有持有满足条件的行会上锁</p><p>这种情况同样适用于RR级别，因此在对一个数据量很大的表做批量修改时，如果无法使用索引，MySQL的过滤速度将会特别慢</p><h1 id=可重复读rr>可重复读(RR)<a href=#可重复读rr class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>RR是InnoDB的默认隔离级别</p><h1 id=读read>读(Read)<a href=#读read class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>可重读是指在一个事务的多个实例并发读取数据时保持一致性</p><p>例如在RC隔离级别下，如果事务A对数据表的某一行进行读取后，事务B也对该行做了修改并提交该事务。此时事务A又对该行进行了读取，最终返回的结果和第一次读取是不一致的，这就是不可重复读RC</p><p>但在RR级别下，即使别的事务对数据进行了修改，后面读取的数据和前面是保持一致的，这就是RR，而如何实现的呢，那就是MVCC了</p><h2 id=不可重复读和幻读的区别>不可重复读和幻读的区别<a href=#不可重复读和幻读的区别 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>不可重复读重点在于update和delete，而幻读重点在于insert</p><p>如果使用锁来实现的话，在可重复读中sql第一次读取数据后就对数据加锁，其他事务无法修改就可实现可重复读但是无法锁住insert的数据，因此事务A如果先读取数据或修改数据，事务B还是可以insert提交数据，这时A中就会发现凭空多出了一条数据，这就是幻读，简单的行锁是不能避免幻读的需要更高级的串行隔离级别，读写用各自的锁并互斥，这样就能有效避免幻读、不可重复读、脏读等问题但会影响数据库的并发性能</p><h2 id=悲观锁和乐观锁>悲观锁和乐观锁<a href=#悲观锁和乐观锁 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ul><li>悲观锁<br>指数据对修改持保持态度，在整个数据处理过程中都把数据锁住其他事务不能干扰只能等待。悲观锁往往凭靠数据库提供的锁来实现，在悲观锁的情况下，为了保证事务的隔离性就需要一致性锁定读。读取时也需要加锁，保证其他事务不能修改该数据；修改时也要加锁，保证其他事务在修改时不能读取数据</li><li>乐观锁<br>乐观锁采用更为宽松的情况下，大部分基于数据版本记录来实现。版本记录就是在数据添加一个版本字段，通常为<code>version</code>。在读取数据时，同时将版本号一并读出，在更新该数据时对其版本号加1。此提交的数据版本会和数据表对应记录的当前版本信息对比，如果提交数据版本号大于数据库表当前版本号，则予以更新，否则认为是过期数据</li></ul><h2 id=innodb中的mvvc>InnoDB中的MVVC<a href=#innodb中的mvvc class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>在InnoDB中，每行数据都会新增两个隐藏字段用于记录何时创建和过期(删除)</p><p>在实际中，存储的并不是时间，而是事务的版本号，每开启一个事务，版本号就会递增，在RR级别下</p><ul><li>SELECT时，读取创建版本号&lt;=当前事务版本号，删除版本号为空或>当前事务版本号</li><li>INSERT时，保存当前事务版本号为行的创建版本号</li><li>DELETE时，保存当前事务版本号为行的删除版本号</li><li>UPDATE时，插入一条新纪录，保存当前事务版本号为行创建版本号，同时保存当前事务版本号到原来删除的行</li></ul><p>MVVC会占用额外的控件，进行更多的行检查和维护工作，但能减少行的使用，大多数读操作都不用加锁</p><p>从理论上说RR也不能解决幻读问题，只有串行化能够解决幻读。但在MySQL中，RR级别下不存在幻读情况</p><h1 id=写当前读>写(当前读)<a href=#写当前读 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>在MySQL中，事务采用了Next-Key锁来解决幻读问题</p><h2 id=next-key>Next-Key<a href=#next-key class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>Next-Key锁是行锁和GAP的合并</p><h1 id=串行化>串行化<a href=#串行化 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>在串行化读写互斥并一并加锁，并使用悲观锁作为机制因此实现简单且更为安全，但是严重影响并发性能造成严重的性能问题</p><p>如果业务并发特别少且要求数据可靠，可以考虑该隔离级别</p></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://blog.zxykm.xyz/tags/mysql>MySQL</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>88 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2021-06-13 04:40 +0000</p></footer></article><div class="post-nav thin"><a class=prev-post href=https://blog.zxykm.xyz/posts/%E7%94%A8%E5%AE%98%E6%96%B9%E7%9A%84%E6%96%B9%E5%BC%8F%E5%AE%89%E8%A3%85archlinux/><span class=post-nav-label>Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>用官方的方式安装Archlinux</span></a></div><div id=comments class=thin></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2021 <a href=https://blog.zxykm.xyz>miRemid</a> &#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://blog.zxykm.xyz/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://blog.zxykm.xyz/js/bundle.min.7d8545daa55d62427355498dd8da13f98ff79a7938ce7d2a5e2ae1ec0de3beb8.js integrity="sha256-fYVF2qVdYkJzVUmN2NoT+Y/3mnk4zn0qXirh7A3jvrg=" crossorigin=anonymous></script></body></html>